<main>
  <div class="page-header">
    <h1>Users Management</h1>
    <p>Manage all registered users</p>
  </div>

  <div class="table-container">
    <p-table #dt [value]="filteredUsers" [paginator]="true" [rows]="5" [rowsPerPageOptions]="[5,10,20]"
      [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      styleClass="p-datatable-striped p-datatable-gridlines p-datatable-sm"
      [globalFilterFields]="['name','username','email','phone','role','status']">

      <!-- Caption with title and search -->
      <ng-template pTemplate="caption">
        <div class="table-caption-wrapper" style="display:flex; justify-content:space-between; align-items:center;">
          <div class="download-wrapper" style="display: flex; gap: 8px;">
            <p-button label="Excel" icon="pi pi-file-excel" styleClass="p-button-success p-button-sm">
            </p-button>

            <p-button label="CSV" icon="pi pi-file" styleClass="p-button-info p-button-sm">
            </p-button>

            <p-button label="PDF" icon="pi pi-file-pdf" styleClass="p-button-danger p-button-sm">
            </p-button>
          </div>
          <div class="search-wrapper">
            <p-floatlabel variant="on" style="width: 100%">
              <input pInputText id="search_user" [(ngModel)]="searchTerm" (input)="applyFilter()" autocomplete="off" />
              <label for="search_role">Search</label>
            </p-floatlabel>
          </div>

        </div>
      </ng-template>

      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr>
          <th>Avatar</th>
          <th pSortableColumn="name">Name <p-sortIcon field="name"></p-sortIcon></th>
          <th pSortableColumn="username">Username <p-sortIcon field="username"></p-sortIcon></th>
          <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
          <th pSortableColumn="phone">Phone <p-sortIcon field="phone"></p-sortIcon></th>
          <th>Role</th>
          <th>Status</th>
          <th pSortableColumn="createdAt">Created <p-sortIcon field="createdAt"></p-sortIcon></th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <!-- Table Body -->
      <ng-template pTemplate="body" let-user>
        <tr>
          <td>
            <div class="user-avatar">
              <img [src]="user.avatar || getDefaultAvatar()" [alt]="user.name" (error)="onAvatarError($event)"
                height="40">
            </div>
          </td>
          <td>{{ user.name }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.phone || 'N/A' }}</td>
          <td>
            <p-chip *ngIf="user.role" [label]="user.role | titlecase"
              [styleClass]="user.role === 'admin' ? 'role-admin' : 'role-user'"></p-chip>
            <span *ngIf="!user.role">Null</span>
          </td>
          <td>
            <p-chip *ngIf="user.status" [label]="user.status | titlecase"
              [styleClass]="'status-' + user.status"></p-chip>
            <span *ngIf="!user.status">Null</span>
          </td>
          <td>{{ user.createdAt | date:'mediumDate' }}</td>
          <td>
            <button pButton pRipple type="button" class="p-button-text p-button-info" (click)="toggleUserStatus(user)"
              [pTooltip]="user.status === 'active' ? 'Deactivate' : 'Activate'">
              <i [ngClass]="user.status === 'active' ? 'pi pi-ban' : 'pi pi-check'"></i>
            </button>
            <button pButton pRipple type="button" class="p-button-text p-button-danger ml-2" (click)="deleteUser(user)"
              pTooltip="Delete">
              <i class="pi pi-trash"></i>
            </button>
          </td>
        </tr>
      </ng-template>

      <!-- Empty Message -->
      <ng-template pTemplate="emptymessage">
        <div class="no-data">
          <i class="pi pi-users" style="font-size:2rem;"></i>
          <p>No users found</p>
        </div>
      </ng-template>

    </p-table>
  </div>
</main>