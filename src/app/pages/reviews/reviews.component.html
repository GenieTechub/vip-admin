<div class="reviews-container">
  <div class="page-header">
    <h1>Review Management</h1>
  </div>


  <!-- Reviews Table -->
  <div class="table-container">
    <p-table [value]="reviews" [paginator]="true" [rows]="10" [loading]="loading" [sortMode]="'multiple'"
      [responsiveLayout]="'scroll'">
      <!-- Caption with title and search -->
      <ng-template pTemplate="caption">
        <div class="table-caption-wrapper">
          <div class="download-wrapper" style="display: flex; gap: 8px;">
            <p-button label="Excel" icon="pi pi-file-excel" styleClass="p-button-success p-button-sm">
            </p-button>

            <p-button label="CSV" icon="pi pi-file" styleClass="p-button-info p-button-sm">
            </p-button>

            <p-button label="PDF" icon="pi pi-file-pdf" styleClass="p-button-danger p-button-sm">
            </p-button>
          </div>
          <div class="search-wrapper">
            <div>
              <p-floatlabel variant="on" style="width: 100%">
                <input pInputText id="search_user" [(ngModel)]="searchTerm" (input)="applyFilter()"
                  autocomplete="off" />
                <label for="search_role">Search</label>
              </p-floatlabel>
            </div>

            <!-- Rating Filter -->
            <p-select [options]="ratingOptions" [(ngModel)]="selectedRating" (onChange)="applyFilter()"
              optionLabel="label" optionValue="value" placeholder="Select Rating" styleClass="w-full md:w-56">
            </p-select>
          </div>

        </div>
      </ng-template>

      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr class="thead">
          <th pSortableColumn="product.name">Product <p-sortIcon field="product.name"></p-sortIcon></th>
          <th>User</th>
          <th pSortableColumn="rating">Rating <p-sortIcon field="rating"></p-sortIcon></th>
          <th>Comment</th>
          <th pSortableColumn="createdAt">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <!-- Table Body -->
      <ng-template pTemplate="body" let-review>
        <tr>
          <!-- Product Column -->
          <td>
            <div class="product-info" style="display: flex; gap: 0.5rem; align-items: center;">
              <img [src]="getProductImageUrl(review.product)" [alt]="review.product?.name" class="product-image"
                style="width: 30px; height: 30px; object-fit: cover;">
              <div>
                <div class="product-name">{{ review.product?.name || 'Unknown Product' }}</div>
                <div class="product-id">ID: {{ review.productId }}</div>
              </div>
            </div>
          </td>

          <!-- User Column -->
          <td>
            <div class="user-info">
              <div class="user-name">{{ review.user?.name || 'Anonymous' }}</div>
              <div class="user-id">ID: {{ review.userId }}</div>
            </div>
          </td>

          <!-- Rating Column -->
          <td>
            <div class="rating-display" style="display: flex; align-items: center; gap: 0.25rem;">
              <div class="stars">
                <mat-icon *ngFor="let star of getStarArray(review.rating)" [class.filled]="star">star</mat-icon>
              </div>
              <span>{{ review.rating }}/5</span>
            </div>
          </td>

          <!-- Comment Column -->
          <td>
            <div class="comment-text" [title]="review.comment">
              {{ review.comment | slice:0:40 }}{{ review.comment?.length > 40 ? '...' : '' }}
            </div>
          </td>

          <!-- Date Column -->
          <td>{{ review.createdAt | date:'short' }}</td>

          <!-- Actions Column -->
          <td>
            <button pButton type="button" icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info"
              (click)="viewProduct(review.productId)" pTooltip="View Product"></button>

            <button pButton type="button" icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger"
              (click)="deleteReview(review)" pTooltip="Delete Review"></button>
          </td>
        </tr>
      </ng-template>

      <!-- Empty Message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" style="text-align: center;">
            <i class="pi pi-info-circle" style="font-size: 2rem;"></i>
            <p>No reviews found</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>