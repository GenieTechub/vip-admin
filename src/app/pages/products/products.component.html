<div class="products-container">
  <div class="page-header">
    <h1>Products Management</h1>
    <p>Manage all products in your store</p>
  </div>

  <!-- Subcategory Filter Banner -->
  <div *ngIf="subcategoryFilter" class="subcategory-filter-banner">
    <div class="filter-info">
      <i class="pi pi-filter"></i>
      <span>Showing products for subcategory: <strong>{{ subcategoryFilter.name }}</strong></span>
    </div>
    <button pButton type="button" icon="pi pi-times" class="p-button-text p-button-sm" 
            (click)="clearSubcategoryFilter()" pTooltip="Clear filter">
    </button>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <p-table [value]="filteredProducts" [loading]="loading" sortMode="multiple" responsiveLayout="scroll"
      class="products-table">

      <ng-template pTemplate="caption">
        <div class="table-caption-wrapper">
          <div class="download-wrapper" style="display: flex; gap: 8px;">
            <p-button label="Excel" icon="pi pi-file-excel" styleClass="p-button-success p-button-sm">
            </p-button>

            <p-button label="CSV" icon="pi pi-file" styleClass="p-button-info p-button-sm">
            </p-button>

            <p-button label="PDF" icon="pi pi-file-pdf" styleClass="p-button-danger p-button-sm">
            </p-button>
          </div>

          <div class="search-wrapper">
            <p-floatlabel variant="on">
              <input pInputText id="search_user" [(ngModel)]="searchTerm" (input)="applyFilter()" autocomplete="off" />
              <label for="search_role">Search</label>
            </p-floatlabel>
            <p-select [options]="categories" [(ngModel)]="selectedCategory" optionLabel="name" optionValue="_id"
              placeholder="All Categories" (onChange)="onCategoryChange()">
            </p-select>

            <p-select [options]="subcategories" [(ngModel)]="selectedSubcategory" optionLabel="name" optionValue="id"
              placeholder="All Subcategories" (onChange)="onSubcategoryChange()">
            </p-select>



            <!-- Status Select -->
            <p-select [(ngModel)]="selectedStatus" [options]="[
          {label:'All Status', value:''},
          {label:'Active', value:'active'},
          {label:'Inactive', value:'inactive'}
        ]" (onChange)="applyFilter()" placeholder="Status" optionLabel="label" optionValue="value"
              styleClass="mr-2"></p-select>

            <button pButton type="button" label="Add Product" icon="pi pi-plus" class="p-button-primary"
              (click)="openAddDialog()"></button>
          </div>
        </div>
      </ng-template>
      <!-- Image -->
      <ng-template pTemplate="header">
        <tr>
          <th>Image</th>
          <th pSortableColumn="name">Name <p-sortIcon field="name"></p-sortIcon></th>
          <th>Category</th>
          <th pSortableColumn="price">Price <p-sortIcon field="price"></p-sortIcon></th>
          <th>Stock</th>
          <th>Status</th>
          <th pSortableColumn="createdAt">Created <p-sortIcon field="createdAt"></p-sortIcon></th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-product>
        <tr>
          <td>
            <img [src]="getProductImageUrl(product)" [alt]="product.name" (error)="onImageError($event)"
              class="product-image" height="40" />
          </td>
          <td>
            <div class="product-info">
              <span class="product-name">{{ product.name }}</span><br />
              <small class="product-description">{{ product.description | slice:0:50 }}...</small>
            </div>
          </td>
          <td>
            <p-chip label="{{ product.category?.name || 'N/A' }}"></p-chip>
          </td>
          <td>
            <span class="price">â‚¹{{ product.price | number: '1.2-2' }}</span>
          </td>
          <td>
            <span [ngClass]="{'low-stock': product.stock < 10}">
              {{ product.stock || 0 }}
            </span>
          </td>
          <td>
            <p-chip [label]="product.status | titlecase" [styleClass]="'status-' + product.status"></p-chip>
          </td>
          <td>{{ product.createdAt | date:'short' }}</td>
          <td>
            <button pButton icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-primary"
              (click)="openEditDialog(product)" pTooltip="Edit"></button>
            <button pButton [icon]="product.status === 'active' ? 'pi pi-eye-slash' : 'pi pi-eye'"
              class="p-button-text p-button-rounded"
              [ngClass]="product.status === 'active' ? 'p-button-danger' : 'p-button-success'"
              (click)="toggleProductStatus(product)"
              [pTooltip]="product.status === 'active' ? 'Deactivate' : 'Activate'"></button>
            <button pButton icon="pi pi-trash" class="p-button-text p-button-rounded p-button-danger"
              (click)="deleteProduct(product)" pTooltip="Delete"></button>
          </td>
        </tr>
      </ng-template>

      <!-- Empty message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="no-data">
            <i class="pi pi-inbox"></i>
            <p>No products found</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>